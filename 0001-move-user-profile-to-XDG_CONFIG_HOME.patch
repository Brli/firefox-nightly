From 8f0833b5ad37a1a133a5d3e9465e3157ccaa2bae Mon Sep 17 00:00:00 2001
From: Brli <brli@chakralinux.org>
Date: Thu, 15 Jan 2026 20:49:17 +0800
Subject: [PATCH] move user profile to XDG_CONFIG_HOME

Floorp patch derived from bugzilla.mozilla.org for Mozilla Firefox

https://bugzilla.mozilla.org/show_bug.cgi?id=259356
Support for the Freedesktop.org XDG Base Directory Specification

phabricator url: https://phabricator.services.mozilla.com/D6995
---
 toolkit/xre/nsXREDirProvider.cpp | 98 ++++++++++++++++++++++++++++----
 toolkit/xre/nsXREDirProvider.h   |  5 +-
 2 files changed, 90 insertions(+), 13 deletions(-)

diff --git a/toolkit/xre/nsXREDirProvider.cpp b/toolkit/xre/nsXREDirProvider.cpp
index 6445643949..6ad78faaf3 100644
--- a/toolkit/xre/nsXREDirProvider.cpp
+++ b/toolkit/xre/nsXREDirProvider.cpp
@@ -1,5 +1,5 @@
 /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
-/* This Source Code Form is subject to the terms of the Mozilla Public
+/* This Source Code Form is subject to the terms of the Ablaze Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
@@ -312,7 +312,7 @@ nsresult nsXREDirProvider::GetBackgroundTasksProfilesRootDir(
  * Get the directory that is the parent of the system-wide directories
  * for extensions and native manifests.
  *
- * On OSX this is /Library/Application Support/Mozilla
+ * On OSX this is /Library/Application Support/Ablaze
  * On Linux this is /usr/{lib,lib64}/mozilla
  *   (for 32- and 64-bit systems respsectively)
  */
@@ -323,7 +323,7 @@ static nsresult GetSystemParentDirectory(nsIFile** aFile) {
   rv = GetOSXFolderType(kOnSystemDisk, kApplicationSupportFolderType,
                         getter_AddRefs(localDir));
   if (NS_SUCCEEDED(rv)) {
-    rv = localDir->AppendNative("Mozilla"_ns);
+    rv = localDir->AppendNative("Ablaze"_ns);
   }
 #  else
   constexpr auto dirname =
@@ -405,11 +405,6 @@ nsXREDirProvider::GetFile(const char* aProperty, bool* aPersistent,
     rv = GetUserDataDirectoryHome(getter_AddRefs(file), /* aLocal */ false,
                                   /* aForceLegacy */ true);
     NS_ENSURE_SUCCESS(rv, rv);
-#  if defined(XP_MACOSX)
-    rv = file->AppendNative("Mozilla"_ns);
-#  else   // defined(XP_MACOSX)
-    rv = file->AppendNative(".mozilla"_ns);
-#  endif  // defined(XP_MACOSX)
   }
 #endif  // defined(XP_UNIX) || defined(XP_MACOSX)
   else if (!strcmp(aProperty, XRE_UPDATE_ROOT_DIR)) {
@@ -973,7 +968,7 @@ nsresult nsXREDirProvider::GetUpdateRootDir(nsIFile** aResult,
             nsDependentCString(hasVendor ? GetAppVendor() : GetAppName())))) {
       return NS_ERROR_FAILURE;
     }
-  } else if (NS_FAILED(localDir->AppendNative("Mozilla"_ns))) {
+  } else if (NS_FAILED(localDir->AppendNative("Ablaze"_ns))) {
     return NS_ERROR_FAILURE;
   }
 
@@ -1151,7 +1146,11 @@ nsresult nsXREDirProvider::GetUserDataDirectoryHome(nsIFile** aFile,
   MOZ_TRY(NS_NewLocalFile(path, getter_AddRefs(localDir)));
 #elif defined(XP_UNIX)
   const char* homeDir = PR_GetEnv("HOME");
+  nsresult rv;
   if (!homeDir || !*homeDir) return NS_ERROR_FAILURE;
+  rv = NS_NewNativeLocalFile(nsDependentCString(homeDir),
+                             getter_AddRefs(localDir));
+  NS_ENSURE_SUCCESS(rv, rv);
 
 #  ifdef ANDROID /* We want (ProfD == ProfLD) on Android. */
   MOZ_TRY(NS_NewNativeLocalFile(nsDependentCString(homeDir),
@@ -1266,7 +1265,7 @@ nsresult nsXREDirProvider::AppendSysUserExtensionPath(nsIFile* aFile) {
 
 #if defined(XP_MACOSX) || defined(XP_WIN)
 
-  static const char* const sXR = "Mozilla";
+  static const char* const sXR = "Ablaze";
   rv = aFile->AppendNative(nsDependentCString(sXR));
   NS_ENSURE_SUCCESS(rv, rv);
 
@@ -1276,9 +1275,11 @@ nsresult nsXREDirProvider::AppendSysUserExtensionPath(nsIFile* aFile) {
 
 #elif defined(XP_UNIX)
 
-  static const char* const sXR = ".mozilla";
+#  if !defined(MOZ_WIDGET_GTK)
+  static const char* const sXR = ".ablaze";
   rv = aFile->AppendNative(nsDependentCString(sXR));
   NS_ENSURE_SUCCESS(rv, rv);
+#  endif
 
   static const char* const sExtensions = "extensions";
   rv = aFile->AppendNative(nsDependentCString(sExtensions));
@@ -1522,6 +1523,79 @@ nsresult nsXREDirProvider::GetLegacyOrXDGHomePath(const char* aHomeDir,
 }
 #endif  // defined(MOZ_WIDGET_GTK)
 
+nsresult nsXREDirProvider::AppendLegacyOrXDGCachePath(const char* aHomeDir,
+                                                      nsIFile** aFile) {
+  nsresult rv;
+  nsCOMPtr<nsIFile> localDir;
+  nsDependentCString homeDir(aHomeDir);
+
+  // If $XDG_CACHE_HOME is defined use it, otherwise use $HOME/.cache.
+  const char* cacheHome = getenv("XDG_CACHE_HOME");
+  if (cacheHome && *cacheHome) {
+    rv = NS_NewNativeLocalFile(nsDependentCString(cacheHome),
+                               getter_AddRefs(localDir));
+  } else {
+    rv = NS_NewNativeLocalFile(homeDir, getter_AddRefs(localDir));
+    if (NS_SUCCEEDED(rv)) {
+      rv = localDir->AppendNative(".cache"_ns);
+    }
+  }
+
+  if (NS_SUCCEEDED(rv)) {
+    localDir.forget(aFile);
+  }
+
+  return rv;
+}
+
+nsresult nsXREDirProvider::AppendLegacyOrXDGHomePath(const char* aHomeDir,
+                                                     nsIFile** aFile) {
+  nsresult rv;
+  nsCOMPtr<nsIFile> localDir;
+  bool exists;
+  nsDependentCString homeDir(aHomeDir);
+
+  // check old config ~/.floorp
+  rv = NS_NewNativeLocalFile(homeDir, getter_AddRefs(localDir));
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  rv = localDir->AppendRelativeNativePath(".floorp"_ns);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  rv = localDir->Exists(&exists);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  // check if we force the use of ~/.floorp
+  const char* legacyhomedir = PR_GetEnv("MOZ_LEGACY_HOME");
+  if (legacyhomedir) {
+    exists = legacyhomedir[0] == '1';
+  }
+
+  // otherwise, use new config
+  if (!exists) {
+    const char* xdghomedir = PR_GetEnv("XDG_CONFIG_HOME");
+    if (!xdghomedir || !*xdghomedir) {
+      rv = NS_NewNativeLocalFile(homeDir, getter_AddRefs(localDir));
+      NS_ENSURE_SUCCESS(rv, rv);
+      rv = localDir->AppendRelativeNativePath(".config"_ns);
+      NS_ENSURE_SUCCESS(rv, rv);
+    } else {
+      rv = NS_NewNativeLocalFile(nsDependentCString(xdghomedir),
+                                 getter_AddRefs(localDir));
+    }
+    NS_ENSURE_SUCCESS(rv, rv);
+
+    rv = EnsureDirectoryExists(localDir);
+    NS_ENSURE_SUCCESS(rv, rv);
+  }
+
+  if (NS_SUCCEEDED(rv)) {
+    localDir.forget(aFile);
+  }
+
+  return rv;
+}
+
 nsresult nsXREDirProvider::AppendProfilePath(nsIFile* aFile, bool aLocal) {
   NS_ASSERTION(aFile, "Null pointer!");
 
@@ -1584,10 +1658,10 @@ nsresult nsXREDirProvider::AppendProfilePath(nsIFile* aFile, bool aLocal) {
   if (!aLocal
 #  if defined(MOZ_WIDGET_GTK)
       && (IsForceLegacyHome() || LegacyHomeExists(nullptr))
-#  endif
   ) {
     folder.Assign('.');
   }
+#  endif
 
   if (!profile.IsEmpty()) {
     // Skip any leading path characters
diff --git a/toolkit/xre/nsXREDirProvider.h b/toolkit/xre/nsXREDirProvider.h
index a850e1c63d..17f6a79ad4 100644
--- a/toolkit/xre/nsXREDirProvider.h
+++ b/toolkit/xre/nsXREDirProvider.h
@@ -95,7 +95,10 @@ class nsXREDirProvider final : public nsIDirectoryServiceProvider2,
     xdgConfigHome
   };
 #endif  // defined(MOZ_WIDGET_GTK)
-
+  static nsresult AppendLegacyOrXDGCachePath(const char* aHomeDir,
+                                             nsIFile** aFile);
+  static nsresult AppendLegacyOrXDGHomePath(const char* aHomeDir,
+                                            nsIFile** aFile);
   /* make sure you clone it, if you need to do stuff to it */
   nsIFile* GetGREDir() { return mGREDir; }
   nsIFile* GetGREBinDir() { return mGREBinDir; }
-- 
2.52.0

