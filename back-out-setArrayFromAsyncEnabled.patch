
# HG changeset patch
# User Matthew Gaudet <mgaudet@mozilla.com>
# Date 1680197564 0
# Node ID 04e3a1505b62157db265be7a330367acc9916eb2
# Parent  8dd52b2dae6b5d0a8958de3fa41420e13d89bdec
Bug 1825356 - Add a preference for Array.fromAsync r=bthrall

Differential Revision: https://phabricator.services.mozilla.com/D174012

diff --git a/js/xpconnect/src/XPCJSContext.cpp b/js/xpconnect/src/XPCJSContext.cpp
--- a/js/xpconnect/src/XPCJSContext.cpp
+++ b/js/xpconnect/src/XPCJSContext.cpp
@@ -778,16 +778,17 @@ static mozilla::Atomic<bool> sWeakRefsEx
 static mozilla::Atomic<bool> sIteratorHelpersEnabled(false);
 static mozilla::Atomic<bool> sShadowRealmsEnabled(false);
 #ifdef NIGHTLY_BUILD
 static mozilla::Atomic<bool> sArrayGroupingEnabled(false);
 #endif
 #ifdef ENABLE_CHANGE_ARRAY_BY_COPY
 static mozilla::Atomic<bool> sChangeArrayByCopyEnabled(false);
 #endif
+static mozilla::Atomic<bool> sArrayFromAsyncEnabled(false);
 #ifdef ENABLE_NEW_SET_METHODS
 static mozilla::Atomic<bool> sEnableNewSetMethods(false);
 #endif
 
 static JS::WeakRefSpecifier GetWeakRefsEnabled() {
   if (!sWeakRefsEnabled) {
     return JS::WeakRefSpecifier::Disabled;
   }
@@ -810,16 +811,17 @@ void xpc::SetPrefableRealmOptions(JS::Re
       .setIteratorHelpersEnabled(sIteratorHelpersEnabled)
       .setShadowRealmsEnabled(sShadowRealmsEnabled)
 #ifdef NIGHTLY_BUILD
       .setArrayGroupingEnabled(sArrayGroupingEnabled)
 #endif
 #ifdef ENABLE_CHANGE_ARRAY_BY_COPY
       .setChangeArrayByCopyEnabled(sChangeArrayByCopyEnabled)
 #endif
+      .setArrayFromAsyncEnabled(sArrayFromAsyncEnabled)
 #ifdef ENABLE_NEW_SET_METHODS
       .setNewSetMethodsEnabled(sEnableNewSetMethods)
 #endif
       ;
 }
 
 void xpc::SetPrefableContextOptions(JS::ContextOptions& options) {
   options
@@ -999,17 +1001,18 @@ static void ReloadPrefsCallback(const ch
   sArrayGroupingEnabled =
       Preferences::GetBool(JS_OPTIONS_DOT_STR "experimental.array_grouping");
 #endif
 
 #ifdef ENABLE_CHANGE_ARRAY_BY_COPY
   sChangeArrayByCopyEnabled = Preferences::GetBool(
       JS_OPTIONS_DOT_STR "experimental.enable_change_array_by_copy");
 #endif
-
+  sArrayFromAsyncEnabled = Preferences::GetBool(
+      JS_OPTIONS_DOT_STR "experimental.enable_array_from_async");
 #ifdef ENABLE_NEW_SET_METHODS
   sEnableNewSetMethods =
       Preferences::GetBool(JS_OPTIONS_DOT_STR "experimental.new_set_methods");
 #endif
 
 #ifdef JS_GC_ZEAL
   int32_t zeal = Preferences::GetInt(JS_OPTIONS_DOT_STR "gczeal", -1);
   int32_t zeal_frequency = Preferences::GetInt(
diff --git a/modules/libpref/init/StaticPrefList.yaml b/modules/libpref/init/StaticPrefList.yaml
--- a/modules/libpref/init/StaticPrefList.yaml
+++ b/modules/libpref/init/StaticPrefList.yaml
@@ -7589,16 +7589,22 @@
 #endif  // NIGHTLY_BUILD
 
   # Experimental support for change-array-by-copy methods
 - name: javascript.options.experimental.enable_change_array_by_copy
   type: bool
   value: false
   mirror: always
 
+# Experimental support Array.fromAsync
+- name: javascript.options.experimental.enable_array_from_async
+  type: bool
+  value: false
+  mirror: always
+
 #if defined(ENABLE_NEW_SET_METHODS)
   # Experimental support for New Set methods
 - name: javascript.options.experimental.enable_new_set_methods
   type: bool
   value: false
   mirror: always
 #endif
 

